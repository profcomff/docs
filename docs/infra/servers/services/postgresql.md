# PostgreSQL

## Что это такое?

PostgreSQL — бесплатная система управления базами данных. С помощью PostgreSQL можно создавать, хранить базы данных и работать с данными с помощью запросов на языке SQL.

Приемущества PostgreSQL хорошо описаны [тут](https://practicum.yandex.ru/blog/chto-takoe-subd-postgresql/)

## Как запустить?

Все сервисы у нас запускаются в Docker контейнерах, PostgreSQL - тоже. Для сохранности данных при остановке контейнера нужно прокинуть volume в контейнер.
Также в данном случае нужно открыть порт для доступа извне. 

Образец `docker-compose.yaml` файла:
```yaml
version: '3.8'


services:
  postgres:
    image: postgres:16
    restart: always
    volumes:
      - profcomff-postgres:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: xxx

volumes:
  profcomff-postgres:
    name: profcomff-postgresql-data
    external: true
```

Тут сказано, что надо запустить образ `postgres:16`, при падениях всегда его рестартовать, прописан volume для сохранности данных, открыт порт наружу и прописан пароль для пользователя `postgres`. Volume тут используется внешний, для того чтобы его невозможно было удалить при остановке контейнеров никакими командами типа `docker compose down` и т.д.

Volume создается командой:
```bash
docker volume create profcomff-postgresql-data
```

## Если внезапно прод начал сыпать ошибками и проблема не найдена

Посмотреть логи PostrgeSQL, если закончилась память он об этом обычно пишет первый.

## Ссылка на БД из бэкендов

Надо следитть на тем, чтобы во всех бэкендах ссылка на PostgreSQL была задана не через IP, а через доменное имя, которое резолвится в IP(задано оно в DNS сервере, на r01)

## Проблема подключений

В какой то момент была обнаружена проблема: в PostgreSQL достаточно мало подключений, которые она можетт держать параллельно открытыми по умолчанию.

По умолчанию значение переменной `max_connection` равно 100.

На каждый инстанс бэкенда на данный момент открывается в среднем по 4 соединения, бэкендов порядка 30, у каждого по 4 инстанса и еще все в двух окружениях. Из примерно такой логики надо рассматривать увеличение переменной `max_connection`. Значения в будущем могут поменяться.

[Здесь](https://stackoverflow.com/questions/30778015/how-to-increase-the-max-connections-in-postgres) описан процесс изменения переменной `max_connection` и `shared_buffers`, которую надо менять вместе с первой.

Также, было принято решение все аналитические инструменты подключать через `PGBouncer`, о котором написана отдельная статья. Он не дает подключениям разможаться бесконтрольно.

## Схема развертывания сейчас

Резвернут 1 инстанс в продовой среде и 1 инстанс в тестовой среде для инструмента проверки доступности сети(пингер).

Лежит в папке `srvc__postgres_db`

## Ссылки
[Официальный сайт](https://www.postgresql.org)

[Статья про PostgreSQL](https://habr.com/ru/companies/tensor/articles/779698/)