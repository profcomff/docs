# file.d

## Что это такое?

Сервис для работы с пайплайнами данных. Поддерживает много сценариев входов/выходов, умеет работать с данными.

У нас он используется для загрузки и обработки логов.

## Как работает?

В конфигурации указываются инпуты данных. В нашем случае это файлы, куда пишут логи докер контейнеры. Они лежат в папке `/var/lib/docker/containers`

file.d читает эти файлы и сохраняет последнюю проччитанную строку для каждого файла в файле offsets.yaml

Далее каждая строка логов обрабатывается по некоторым правилам и загружается в нашем случае в PostgreSQL.

## Формат логов
Формат логов для бэкендов задается в библиотеке [logging-profcomff](https://github.com/profcomff/logging-lib)

## Настройка

Файл конфигурации содержит в себе пайплайны. В каждом пайплайне есть input, actions, output.

На данный момент пайплайна два: загрузка логов и загрузка результатов выполнения команды `docker ps -a` для того, чтобы маппить id контейнера на имя бэкенда.

`docker-compose.yaml` выглядит примерно так:

```yaml
version: '3'

services:
  log_stash:
    image: ghcr.io/ozontech/file.d:v0.27.1
    restart: always
    volumes:
      - ./config:/config
      - /var/lib/docker:/var/lib/docker
      ...
    command: /file.d/file.d --config /config/filed_conf.yaml
```

В папке config должны лежать: конфиг и файлы оффсетов.

## Схема развертывания сейчас

Резвернут 1 инстанс в продовой среде и 1 инстанс в тестовой среде.

Лежит в папке `srvc__filed_logs`

## Ссылки
[Официальный репозиторий](https://github.com/ozontech/file.d)

[Доклад на Highload](https://youtu.be/0q9UyUlYPos?si=z-Gjm5H07k4EzWks)
