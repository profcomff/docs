# Настройка DNS

## Что такое DNS

DNS - Domain Name System - это система, преобразующая человекочитаемые доменные имена в IP-адреса, понимаемые машиной.

DNS занимается тем, что преобразует названия сайтов — доменные имена, которые вводят в поисковую строку браузера в IP-адреса конкретных серверов. Если бы не было DNS, вам бы пришлось запоминать IP-адреса нужных вам ресурсов и вводить их вручную в браузер.

DNS-серверы бывают корневыми, они отвечают за самый верхний уровень — «.», отвечающими за геозоны — .ru,.com,.io,.by,.kz и локальные DNS-серверы.

Самая простая ситуация — это когда DNS-запись содержит лишь сведения о соотношении IP-адреса сервера с доменным именем, но данных может быть куда больше. Например, у сайта, поддоменов и почтового сервера могут быть разные IP-адреса и вся эта информация должна хранится в одном месте — специальном файле на DNS-сервере, его содержимое называется DNS-зона.

Файл содержит следующие типы записей:

- `А`-запись — привязка IP-адреса веб-ресурса к конкретному имени домена;

- `AAAA`-запись — преобразование имени хоста в IPV6-адрес;

- `MX`-запись — адрес почтового сервера в текущем домене;

- `CNAME`-запись — запись для подключения поддомена или перенаправления на основной домен;

- `NS`-запись — адрес DNS-сервера, обслуживающего данный домен;

- `TXT`-запись — произвольная текстовая информация о доменном имени;

- `SOA` — начальная запись зоны, которая указывает местоположение эталонной записи о домене;


В каждой записи есть:
1. Доменное имя (например, `docs.profcomff.com` содержится в зоне `profcomff.com`)
2. TTL - время жизни кэша записи
3. Класс записи (обычно IN - сокращение от INternet)
4. Значение записи

### Пример
```
profcomff.com.		21600	IN	A	45.12.6.132
```
Говорит о том, что запись profcomff.com типа A, имеет TTL равный 21600 и ее значение `45.12.6.132`

### Пример
```
profcomff.com.		21600	IN	MX	10 mail.profcomff.com.
mail.profcomff.com.	21600	IN	A	45.12.6.132
```
Говорит о том, что запись profcomff.com типа MX (почта), имеет TTL равный 21600 и ее значение `10 mail.profcomff.com.` 10 - это приоритет записи, играет роль только если почтовых серверов много, тогда можно управлять ситуациями их падения.

`mail.profcomff.com` в свою очередь ведет на `45.12.6.132`

## Как работает DNS у нас
Мы успользуем DNS предоставляемый хостером домена profcomff.com
Узнать это можно так:
```
profcomff.com.		21600	IN	NS	ns2.r01.ru.
profcomff.com.		21600	IN	NS	ns1.r01.ru.
```
NS сервера это как раз сервера, обслуживающие данную зону.

Зону обслуживает компания r01

На их сайте можно редактировать эти записи.

## Как настроить DNS в Твой ФФ
В первую очередь надо получить туда доступ. Его можно запросить у лидов.

1. Заходим на [сайт](https://r01.ru)
2. Переходим во вкладку `Вход для клиентов`, заходим
3. Переходим на вкладку Домены->Международные домены

![Международные домены](../_images/infra/domainsr01_dns.png)

4. Нажимаем на синий значок с подписью `Нажмите для управления  DNS-зоной на DNS серверах регистратора`
5. Видим список записей

![Список записей](../_images/infra/rrsr01_dns.png)
И так далее. На крест запись можно удалить, на каранаш редактирование.

### Создание записи
Начинем с предыдущей страницы (шаг 5).

Пролистываем вверх и видим окно `Добавление записи в DNS`

![Окно добавления записи](../_images/infra/addrrr01_dns.png)

Добавляем все поля, которые нас просят и нажимаем кнопку подтверждения.

![Окно добавления записи](../_images/infra/addedrrr01_dns.png)

Запись создана и разнесется по серверам регистратора в течение нескольких часов.

### Как понять какая должна быть запись
__Основной сценарий - надо добавить запись для нового микросервиса/базы данных__

В таком случае вам надо использовать A запись и направлять ее на IP адрес сервера на котором стоит конечный микросервис. 

Когда будет посылаться запрос, он разрезолвит доменное имя на соответствующий IPv4 и адресуется он на порт 443 (https) или 80 (http)

Принимается этот запрос нашим балансировщиком нагрузки (Caddy server). Он слушает как раз порты 80 и 443. О нем написана другая статья. И вот уже он, на основании запроса к нему пришедшего, делает выбор, в какой контейнер этот запрос послать.

Выглядит это примерно так:
```
api.profcomff.com:443 {
    route /marketing/* {
        reverse_proxy com_profcomff_api_marketing:80
    }
}
```
То есть, когда приходит запрос на конкретный сервер (IP мы знаем по записи DNS) он попадает в Caddy и, если его путь начинается с `/marketing`, то он перенаправляется в контейнер com_profcomff_api_marketing на порт 80 сразу внутрь контейнера.

Однако, если указать после имени домена еще порт в формате: `dns.name.com:9876`, то запрос пойдет сразу на этот порт. _Таким образом можно спрятать базу данных за DNS и потом ее можно будет проще перенести_, не придется менять IP адреса во всех компонентах, которые с ней общаются.

__Еще один сценарий состоит в том, что у вас уже есть готовое доменное имя, а вы хотите ему прописать алиас.__

В таком слуае вам пригодится CNAME запись.

Например:
```
pages.profcomff.com.	21600	IN	CNAME	profcomff.github.io.
```

Говорит о том, что `pages.profcomff.com` является алиасом к `profcomff.github.io`.

Такие записи сразу перенаправляются на алиас, настраивать наш Caddy не нужно.

__Остальные сценарии маловероятны__, хотя в теории вам может пригодится настроить почту по новому или еще что то, в таком случае информацию стоит поискать в гайдах в интернете.

### Как перенести сервис безболезненно
1. Если сервис не имеет состояния, тогда просто разверните новый сервис по новому адресу и поменяйте запись, старый сервис не трогайте. Какие то запросы будут идти в старый, какие то в новый, в коцне концов, все мигрирует на новый, когда у всех обновятся кэши

2. Если сервис имеет состояние и первый вариант невозможен, можно опустить TTL всех записей, относящихся к этому сервису в ноль, подождать пока изменения разнесутся, а дальше сделать миграцию: запустить новый сераис, остановить старый, поменять значение записи DNS, поднять TTL

### Создал запись, а сервис все равно недоступен
Изменения разносятся какое то время (до нескольких часов), так что скорее всего дело в этом. В ином случае можно обратиться к более опытным людям.

### Как дебагать DNS записи
Поможет утилита `nslookup`.

О команде `nslookup` есть подсказка [здесь](https://help.r01.ru/dns/faq/nslookup.html)

Сделаем что то командой `nslookup`: Запросим данные по домену `api.profcomff.com`
```
➜  ~ nslookup api.profcomff.com     
Server:		192.168.0.1
Address:	192.168.0.1#53

Non-authoritative answer:
Name:	api.profcomff.com
Address: 45.12.6.132
```

Нас интересует `Non-authoritative answer` - там и есть ответ на наш запрос.

Можно выбрать конкретный тип записи:
```
➜  ~ nslookup -type=A api.profcomff.com
Server:		192.168.0.1
Address:	192.168.0.1#53

Non-authoritative answer:
Name:	api.profcomff.com
Address: 45.12.6.132
```

Тут видно какие записи существуют и разнеслись по серверам.

Видно, что отвечает на запрос сервер `192.168.0.1#53` - это кэширующий локальный DNS-сервер. Запросы можно перенаправить на конкретный сервер, если вы знаете его адрес. Его можно узнать вот так:

```
➜  ~ nslookup -type=NS profcomff.com
Server:		192.168.0.1
Address:	192.168.0.1#53

Non-authoritative answer:
profcomff.com	nameserver = ns2.r01.ru.
profcomff.com	nameserver = ns1.r01.ru.

Authoritative answers can be found from:
ns1.r01.ru	internet address = 31.177.80.41
ns2.r01.ru	internet address = 89.111.166.6
```

Нам нужны сервера из `Authoritative answers can be found from`. Мы можем взять их IP и послать запрос на них конкретно:

```
➜  ~ nslookup profcomff.com 31.177.80.41
Server:		31.177.80.41
Address:	31.177.80.41#53

Name:	profcomff.com
Address: 45.12.6.132
```

Это может пригодится, если запись долго не обновляется у вас в кэше

Если записи не существует вамм будет приходить такой ответ
```
➜  ~ nslookup no.profcomff.com     
Server:		192.168.0.1
Address:	192.168.0.1#53

** server can't find no.profcomff.com: NXDOMAIN
```

### У кого просить помощи
У людей, имеющих доступ к r01 уже давно, на момент написания статьи это Роман и Семен. Спросите их контакты в чате команды.