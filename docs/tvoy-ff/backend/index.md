# Backend-разработка

> **Note**
> Документации по всем API можно посмотреть тут: https://api.profcomff.com/

Бэкенд — начинка сайта или приложения, скрытая от пользователя. Бэкендом называют программно-аппаратную часть сервиса, которая работает на сервере, а не в браузере или на компьютере.

## Зачем нужен?
Слой бэкенда нужен для того, чтобы:
1. Упростить разнесение обновлений до конкретных пользователей: бэкенд разворачивается на наших серверах, где мы контролируем обновления
2. Скрыть чувствительные данные от пользователей
3. Упростить работу пользовательского устройства, снизить требования к его железу
4. Разделить UI и сложные алгоритмы, продиктованные бизнес логикой

## Разработка
В нашей команде разработка ведется с использованием `python3.11`. Используемые библиотеки: `Pydantic` - для сериализации и десиарелизации данных, `FastAPI` - HTTP-сервер, `SQLAlchemy` - для работы с базами данных, `alembic` - для генерации миграций баз данных, `black` и `isort` - для форматирования кода, `pytest` - для тестирования кода.

Используемые технологии: `PostgreSQL`, `Kafka`, `Docker`

Все зависимости прописываются в файле `requirements.txt` без указания версий (для того, чтобы они автоматически скачивали самую новую). Разработческие зависимости можно прописывать в `requirements.dev.txt`. Там мы точно указываем [black](https://pypi.org/project/black/), [isort](https://pypi.org/project/isort/). Если вы склонировали один из наших проектов, то после настройки конфигурации запуска и создания venv, стоит запустить `pip install -m requirements.txt -r requirements.dev.txt`. После этого все зависимости установятся.

## Структура проекта
- `./github` и лежащая в ней `./github/workflows`: папки, где лежат папйплайны CI/CD. Что такое CI/CD можно почитать тут: <https://habr.com/ru/companies/otus/articles/515078/>. Эта папка вам нужна, если вы хотите добавить автоматический запуск на какое то событие в GitHub какого то действия. Например, запуск тестов на каждый Pull request
- `LICENSE` - файл с лицензией на открытый код
- `README.md` - документация к проекту
- `pyproject.toml` - конфигурация проекта Python. Что это такое: можно почитать тут: <https://packaging.python.org/en/latest/guides/writing-pyproject-toml/>
- `.gitignore` - файл с описанием того, что должен игнорировать git при коммитах
- `Dockerfile` - файл с описанием сборки проекта для запуска его в docker контейнере
- `requirements.txt`, `requirements.dev.txt` - файлы зависимостей
- Сам проект, папка с исходным кодом
- Папка с тестами
- Папка с миграциями для БД

## Как сделать Pull request

Для начала, вы должны помнить следующее:

1. __Все__ пароли, Redierct URLs и прочее указываются в `.env` файле и подгружается в класс `Settings`. Мы не храним пароли и адреса наших серверов в коде.

2. Кроме `requirements.txt` в корне проекта лежат файлы: `.env`, `.gitignore`, `flake8.conf`, `pyproject.toml`, `LICENSE`. Это все файлы конфигураций и файлы для GitHub - вообще относительно разработческие штуки. Их можно взять в любом готовом проекте (кроме `.env`)

3. Если вы создаете PR в пустом репозитории: В корне проекта создается __исполняемый__ модуль и модуль __тестов__, папка с миграциями, путь `/.github/workflows/`. В каждой директории модулей должен лежать файл `__init__.py`, а в директории исполняемого модуля должен лежать и файл `__main__.py`. Запускать надо исполняемый модуль (`python3 -m...`)

4. __Любые__ изменения в БД должны сопровождаться генерацией файла миграций. Ваша БД должна содержать только те таблицы, которые нужны в данном проекте.

5. __Любые__ изменения в структуре проекта должны быть прописанными в `Dockerfile`, __если они его затронули__. При создании папок, если они пустые, создавайте там пустой файл `.gitkeep`, иначе папка может не закоммититься. После этого не забудьте прописать этот путь в `Dockerfile`.

### __Итак__, чтобы сделать Pull request, вам надо:

1. Создать ветку в GitHub, работать в ней
2. Написать код, решающий задачу
3. Написать тесты к вашему коду
4. Проверить, сгенерирован ли файл миграций, если изменена структура БД
5. Проверить, все ли папки, созданные вами, закоммитились в вашу ветку. Проверить, добавили ли вы их в Dockerfile
6. Проверить соответствие проекта стандартам PEP8, прогнать по коду black
7. Запросить review у любого из старших разработчиков
8. Исправить ошибки, если присутствуют на этапе review
9. Merge! Вы великолепны.

## Как создать новый проект
1. Создайте репозиторий, можете инициализировать его первым коммитом с `README.md` (вам предложит это GitHub)
2. Сделайте все действия, описанные тут: <https://github.com/profcomff/fastapi-template>
3. Закоммитьте изменения прямо в мастер
4. Создайте feature ветку и делайте там проект

## Проверяем корректность миграций
1. Просим админов БД скинуть нужный дамп (получить его можно только если есть соответствующие доступы)
Команда для дампа: `pg_dump -U {role} -h {host} -p {port} -d {db_name} -n {schema_name} > /tmp/{name}.dump`
2. Кидаем его в БД:
`psql -U {role} -h localhost -p 5432 -d {db_name} < /tmp/{name}.dump`
3. Применяем миграции на локальной БД.

## Выкатка в прод новой функциональности
Бэкенд уже должен существовать в проде, если вы только создали репозиторий и написали там проект, вам стоит заглянуть в статью "Выкатка сервиса в продакшн"

1. Зайти в репозиторий
2. Нажать на `Releases`
3. Нажать на `Draft new release`
4. Нажать `Choose a tag`, вписать там новый тег в формате сегодняшней даты: `vYYYY.MM.DD`, буква `v` обязательна 
5. Название релиза должно содержать в префиксе (в начале) название созданного тега
6. Нажать `Generate release notes`
7. Проверить, что нажата галочка `Set as the latest release`
8. Нажать `Publish release`
9. Дождаться, пока перераскатается тестовое окружение
10. Написать в чат о том, что вы раскатали сервис и позвать ответственного за сервис, чтобы он подтвердил раскатку в прод

## Code style
В каждом проекте существует договоренность по стилю. Вся эта договоренность сводится к запуску этой команды:
```bash
make format
```

Но для этого надо иметь на компьютере `make`

Если его нет, то запустите это:
```bash
isort ./<app_name>
black ./<app_name>
isort ./tests
black ./tests
isort ./migrations
black ./migrations
```

`<app_name>` - это папка с кодом, в которой лежит весь проект.

## Naming Convention
Переменные, модули и функции мы называем в формате `lower_case`

Классы мы называем в формате `CamelCase`

Более подробный гайд можно найти тут: <https://peps.python.org/pep-0008/#naming-conventions>

## Полезные ссылки и источники информации
- <https://pydantic-docs.helpmanual.io>
- <https://fastapi.tiangolo.com>
- <https://docs.sqlalchemy.org/en/20/>
- <https://docs.pytest.org/en/7.1.x/contents.html>
