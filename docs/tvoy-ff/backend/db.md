# Как работаем с базой данных
Основной базой данных у нас является `PostgreSQL`

Для работы с БД мы используем `SQLAlchemy`. Это очень мощный инструмент разработки с встроенным ORM. Смысл ORM - установка соответствий между моделями с БД и объектами в python. Таким образом, вы работаете с экземплярами соответствующих классов, а не с чистыми SQL-запросами, которые зачастую очень громоздкие и неудобные в дальнейшей работе с ними.

Для начала, создаются все модели(классы) в python. Путь к ним обычно выглядит как /models/db.py. Поля таких классов - колонки. При создании таблиц `sqlalchemy.mapped_column` создает нужную колонку, а в дальнейшем при обращении к этому полю, выдает значение для текущей строки в БД.
<https://docs.sqlalchemy.org/en/20/orm/quickstart.html#declare-models>

После создания моделей, описываются `relationships` между ними. Это нужно для простой и быстрой реализации больших и, кажется, ненужных запросов. То есть, `childrens = session.query(Parent).filter(Children.parent_id == parent.id).all()` превращается в `parent.childrens`. Очень упрощает читаемость кода.
<https://docs.sqlalchemy.org/en/20/orm/basic_relationships.html>

Отношения между моделями бывают разные: one-to-one, one-to-many, many-to-many. Все их реализации достаточно просты, но в любом случае требуют изучения:
1. <https://docs.sqlalchemy.org/en/20/orm/basic_relationships.html#one-to-many>
2. <https://docs.sqlalchemy.org/en/20/orm/basic_relationships.html#one-to-one>
3. <https://docs.sqlalchemy.org/en/20/orm/basic_relationships.html#many-to-many>

В процессе разработки структура БД может меняться, для того, чтобы это все автоматически раскатывалась на сервере, мы используем alembic.  __Любые__ изменения в БД должны сопровождаться генерацией __нового__ файла миграций. Ваша БД должна содержать только те таблицы, которые нужны в данном проекте.

__Бесполезно изменять файл уже существующий файл миграций__

__При изменении моделей БД__:
1. Запустить:
    ```bash
    alembic revision --autogenerate -m "issue_number_and_name"
    ```
2. Проверьте, что в папке `migrations/versions` создался новый файлик и его содержимое соответствует вашим ожиданиям
    - Если что-то сформировалось не так, обязательно поправьте. Обычно переименования колонок или таблиц алембиком воспринимаются как удаление и создание новых, это ошибка!
    - Запустить автоформатирование файла с помощью `black` и `isort`, чтоб делать файлики миграций красивыми
3. Запустить,  для применения миграций:
    ```bash
    alembic upgrade head
    ```
